<!DOCTYPE html>
<html>
{% if user.is_authenticated %}
Hi {{ user.username }}!
        <head>
            <meta charset="utf-8">
            <title>My Job Applications</title>
            {% load static %}
            <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
            <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
            <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
            <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script> 
        </head>
        <body>
            <div class="row">
                <ul style = "min-width: 100px;" class="list-group list-group-horizontal connectedStage">
                    {% for stage in latest_stage_list %}
                        <li class="list-group-item ui-state-default"><a href="{% url 'jobboard:edit_stage' stage.id %}">{{ stage.stage_title }}</a>
                            <p><a href="{% url 'jobboard:delete_stage' stage.id %}" class="button">Delete Stage</a> </p>   
                            <ul style = "min-height: 100px;" id = "{{ stage.stage_title }}" class="connectedSortable">
                                {% for posting in stage.ordered_posting_set %}
                                    <li  id="entry_{{posting.id}}" class="ui-state-default card"><a href="{% url 'jobboard:detail_view' posting.id %}">{{posting.job_title}}</a>
                                    <p>{{posting.deadline}}</p>
                                    <p>{{posting.job_description}}</p>
                                    <p>{{posting.job_url}}</p>
                                    <p>{{posting.job_email}}</p>
                                    </li>
                                {% endfor %}
                            </ul>  
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <p> <a href="{% url 'jobboard:create_stage'%}" class="button">Add Stage</a> </p>    
        <p> <a href="{% url 'jobboard:create_post'%}" class="button">Create Post</a> </p>
        <p><a href="{% url 'logout' %}">Log Out</a></p>
    
     </body>
{% else %}
<p>You are not logged in</p>
<a href="/accounts/login/">Log In</a>
{% endif %}
</html>

<!-- required for CSRF cookie parsing //-->
<script src="{% static 'js/jquery-sortable.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
<script>
// get the Django CSRF Cookie
$(function() {
    var csrftoken = Cookies.get('csrftoken');
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
    });
// Make our ordered list with a class of example sortable.
// onDrop (reorder item) make a JSON representation of the list and POST the JSON to the current page

var group = $(".connectedSortable" ).sortable({
        connectWith: '.connectedSortable',
        delay: 500,
        update: function () {
            const arr = [];
            {% for stage in latest_stage_list %}
                var data = $(document.getElementById("{{ stage.stage_title }}")).sortable("serialize", {key:"id"});
                arr.push(data)
            {% endfor %}
            $.ajax({
                        type: "POST",
                        data: JSON.stringify(arr),
                        url: ""
                    });
        },
});
}).disableSelection();
</script>
  